#!/usr/bin/env bash

set -eu
set -o pipefail


OPTS='hlgbtapes'
LONG_OPTS='help,light,dark,les,lesbian,gay,bi,bisexual,trans,transgender,ace,asexual,pan,pansexual,enby,straight'
FLAGS=(-l -g -b -t -a -p -e)

PARSED="$(getopt --options="$OPTS", --longoptions="$LONG_OPTS" --name="$0" -- "$@")"
eval set -- "$PARSED"


HELP=0
BG_LIGHT=0
BG_DARK=0

LES=0
GAY=0
BI=0
TRANS=0
ACE=0
PAN=0
ENBY=0
STRAIGHT=0


while true
do
  case "$1" in
    -h|--help)
      HELP=1
      shift
      ;;
    --light)
      BG_LIGHT=1
      shift
      ;;
    --dark)
      BG_DARK=1
      shift
      ;;
    -l|--les|--lesbian)
      LES=1
      shift
      ;;
    -g|--gay)
      GAY=1
      shift
      ;;
    -b|--bi|--bisexual)
      BI=1
      shift
      ;;
    -t|--trans|--transgender)
      TRANS=1
      shift
      ;;
    -a|--ace|--asexual)
      ACE=1
      shift
      ;;
    -p|--pan|--pansexual)
      PAN=1
      shift
      ;;
    -e|--enby)
      ENBY=1
      shift
      ;;
    -s|--straight)
      STRAIGHT=1
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      >&2 printf '%s\n' '!ERR!'
      exit 2
      ;;
  esac
done


HELP_TEXT="$(tee <<- EOF
usage:
$ echo 'TEXT' | gay

flags:
-l  --les      --lesbian
-g  --gay
-b  --bi       --bisexual
-t  --trans    --transgender
-a  --ace      --asexual
-p  --pan      --pansexual
-e  --enby
-s  --straight

backgrounds:
  --light
  --dark
EOF
)"


if [[ $HELP -eq 1 ]]
then
  printf '%s\n' "$HELP_TEXT"
  exit 0
fi


if [[ $# -eq 0 ]]
then
  TEXT="$(< /dev/stdin)"
else
  TEXT="$*"
fi


if [[ $STRAIGHT -eq 1 ]]
then
  printf '%s\n' "$TEXT"
  exit 0
fi


C_LES=()
C_GAY=()
C_BI=()
C_TRANS=()
C_ACE=()
C_PAN=()
C_ENBY=()

C_BG_LIGHT=
C_BG_DARK=


if [[ $LES -eq 1 ]]
then
  COLOURS=("${C_LES[@]}")
elif [[ $GAY -eq 1 ]]
then
  COLOURS=("${C_GAY[@]}")
elif [[ $BI -eq 1 ]]
then
  COLOURS=("${C_BI[@]}")
elif [[ $TRANS -eq 1 ]]
then
  COLOURS=("${C_TRANS[@]}")
elif [[ $ACE -eq 1 ]]
then
  COLOURS=("${C_ACE[@]}")
elif [[ $PAN -eq 1 ]]
then
  COLOURS=("${C_PAN[@]}")
elif [[ $ENBY -eq 1 ]]
then
  COLOURS=("${C_ENBY[@]}")
else
  FLAG=${FLAGS[$((RANDOM % ${#FLAGS[@]}))]}
  exec "$0" "$FLAG" "$@" <<< "$TEXT"
fi


pprint() {
  local text="$1"
  local colour="$2"
  printf '%s%d%s%s%s' '\e[0;' "$colour" 'm' "$text" '\e[0m'
}


readarray -t LINES <<< "$TEXT"
MAX_LEN=0
for line in "${LINES[@]}"
do
  len=${#line}
  if [[ $len -gt $MAX_LEN ]]
  then
    MAX_LEN=$len
  fi
done


OUT=''
for line in "${LINES[@]}"
do
  len=${#line}
  for ((i=0; i<=len; i++))
  do
    if [[ $i -eq $len ]]
    then
      OUT="${OUT}"$'\n'
    else
      OUT="${OUT}${line:$i:1}"
    fi
  done
done


printf '%s' "$OUT"
